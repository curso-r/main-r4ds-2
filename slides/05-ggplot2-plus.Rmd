---
title: "R para Ciência de Dados 2"
subtitle: "ggplot2 ++"
author: "<img src = 'https://d33wubrfki0l68.cloudfront.net/9b0699f18268059bdd2e5c21538a29eade7cbd2b/67e5c/img/logo/cursor1-5.png' width = '30%'>"
date: "`r paste(lubridate::month(Sys.Date(), label = TRUE, abbr = FALSE, locale = 'pt_BR.UTF-8'), 'de', lubridate::year(Sys.Date()))`"
output:
  xaringan::moon_reader:
    css: ["default", "default-fonts", "css/custom-intro.css"]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: "4:3"
---

```{r setup, include=FALSE}
`%>%` <- magrittr::`%>%`

blue <- function(x) {
  glue::glue(
    '<span style="color:#6495ed; font-weight: bold;">{x}</span>'
  ) %>% 
    htmltools::HTML()
}

colorido <- function(x, cor) {
  glue::glue(
    '<span style="color:{cor}; font-weight: bold;">{x}</span>'
  ) %>% 
    htmltools::HTML()
}

options(width = 85)
```

class: titulo
# Motivação

---
## Aquecimento

Já vimos que o `{ggplot2}` é um excelente framework para construção de gráficos estatísticos. Além de produzir gráficos naturalmente bonitos, todos os gráficos seguem a mesma sintaxe e filosofia (*layered grammar of graphics*).

Para aquecermos, vamos fazer um gráfico de dispersão do valor de venda vs qualidade geral das casas da base `ames`.

```{r}
library(dplyr)
library(ggplot2)

ames <- readr::read_rds("../data/ames.rds")
```


---
## Um gráfico de dispersão


```{r}
ames %>%
  ggplot() +
  geom_point(aes(x = geral_qualidade, y = venda_valor))
```

---
## Melhorando o visual

```{r}
ames %>%
  ggplot() +
  geom_point(aes(x = geral_qualidade, y = venda_valor)) +
  labs(x = "Qualidade", y = "Valor da venda ($)") +
  scale_x_continuous(breaks = 1:10) +
  theme_minimal()
```

---
## Um pouco de manipulação

Transformando `geral_qualidade` em uma variável categórica e mudando escala do valor

```{r}
ames %>%
  mutate(
    geral_qualidade = as.character(geral_qualidade),
    venda_valor = venda_valor / 1000
  ) %>%
  ggplot() +
  geom_boxplot(aes(x = geral_qualidade, y = venda_valor)) +
  labs(x = "Qualidade", y = "Valor da venda (em milhares de dólares)") +
  theme_minimal()
```

---
## Fatores

```{r}
ames %>%
  mutate(
    geral_qualidade = as.factor(geral_qualidade),
    venda_valor = venda_valor / 1000
  ) %>%
  ggplot() +
  geom_boxplot(aes(x = geral_qualidade, y = venda_valor)) +
  labs(x = "Qualidade", y = "Valor da venda (em milhares de dólares)") +
  theme_minimal()
```

Quais hipóteses você consegue levantar a partir desse gráfico?

---
## O que vamos ver...

Para estendermos repertório gráfico, vamos aprender a seguir a fazer mapas no `{ggplot2}`, contando com a ajuda do pacote `{sf}`.  

Além disso, para deixarmos nosso gráficos ainda mais charmosos, vamos discutir como mexer em qualquer aspecto visual de um ggplot.

Para finalizar, vamos ver duas extensões do `{ggplot2}` muito úteis para comunicação.

---
class: titulo

# Mapas com {ggplot2}

---
## O pacote {sf}

Simple Featuares (sf) é um conjunto de padrões que especificam um modelo de armazenamento e acesso de características geográficas (pontos, retas ou polígonos).

No R, temos o excelente pacote `{sf}` que nos permite trabalhar com dados geográficos nesse padrão.

Se você ainda não tiver o pacote `{sf}` instalado, instale e carregue o pacote usando o código abaixo.

```{r, eval=FALSE}
install.packages("sf")
library(sf)
```

---

Para produzirmos nosso primeiro mapa, vamos utilizar um arquivo que vem com o próprio pacote `{sf}`. 

O arquivo `nc.shp` possui os limites geográficos dos municípios do Estado da Carolina do Norte, nos EUA. A extensão `.shp`, conhecida como *shape file*, é muito comum para guardar dados geoespaciais

A função `system.file()` devolve o caminho para esse arquivo.

Para ler um arquivo `.shp`, basta utilizarmos a função `sf::st_read()`. O objeto criado é um `data.frame` com a classe extra `sf`. 

```{r}
arquivo <- system.file("shape/nc.shp", package = "sf")
tab_nc <- sf::st_read(arquivo, quiet = TRUE)
```
---
A característica mais importante desse objeto é a existência de uma coluna chamada `geometry`, que guarda as informações geográficas. Neste caso, ela guarda um conjunto  de pares longitude/latitude, que determinam, neste caso, um polígono.

De modo geral, Informações geográficas são determinadas por pontos, retas e polígonos.

```{r}
head(tab_nc, 5)
```

---

Para plotar o mapa utilizando o `{ggplot2}`, basta usarmos o `geom_sf()`. Por padrão, a função `geom_sf()` vai procurar a coluna `geometry` na sua base.

```{r}
tab_nc %>%
  ggplot() +
  geom_sf()
```

---

Podemos preencher a área dos municípios segundo a variável `AREA`.

```{r}
tab_nc %>%
  ggplot() +
  geom_sf(aes(fill = AREA))
```

---

Para mudar a cor ou tamanho das bordas, basta utilizarmos os argumentos `color` ou `size`.

```{r}
tab_nc %>%
  ggplot() +
  geom_sf(aes(fill = AREA), color = "white", size = 1)
```

---

Se quisermos colocar textos dentro dos polígonos, bastautilizarmos as funções `geom_sf_text()` ou `geom_sf_label()`.

```{r}
tab_nc %>%
  ggplot() +
  geom_sf(aes(fill = AREA), color = "white") +
  geom_sf_text(aes(label = NAME), size = 1.5, color = "white")
```

---
# Mapas do brasil

Podemos fazer mapas do Brasil utilizando o pacote `geobr`. Para mais detalhes, visite o [repositório no Github](https://github.com/ipeaGIT/geobr).

Rode o código abaixo para instalar e carregar o pacote.

```{r, eval = FALSE}
install.packages("geobr")
library(geobr)
```

Para carregar a geometria do Brasil, rodamos o código abaixo. Ele fará o download dos dados e salvará no objeto `tab_brasil`. A tabela criada só possui a coluna `geometry`.

```{r}
tab_brasil <- geobr::read_country()
```

---

Com o objeto `tab_brasil`, conseguimos fazer um mapa do Brasil facilmente.

```{r}
tab_brasil %>%
  ggplot() +
  geom_sf()
```

---

Se quisermos fazer a seperação dos estados, basta utilizarmos a função `geobr::read_state()`. Veja que essa tabela possui mais informações.

```{r}
tab_estados <- geobr::read_state()
head(tab_estados, 5)
```

---

Utilizamos a coluna `abbrev_state` para colocar a sigla dos estados.

```{r}
tab_estados %>%
    ggplot() +
    geom_sf() +
    geom_sf_text(aes(label = abbrev_state), size = 2)
```

---

Veja que o código anterior demora para rodar. Isso acontece porque um mapa com muitos detalhes demora para ser "desenhado". Podemos simplificar os polígonos de uma mapa utilizando a função `sf::st_simplify()`. O argumento `dTolerance` determina o nível da simplificação. Quanto maior o valor, mais simples serão os polígonos.

```{r}
tab_estados %>%
  sf::st_simplify(dTolerance = 0.1) %>%
  ggplot() +
  geom_sf() +
  geom_sf_text(aes(label = abbrev_state), size = 2)
```

---

Também podemos usar a função `geom_sf_label()` para escrever textos nos mapas.

```{r}
tab_estados %>%
  sf::st_simplify(dTolerance = 0.1) %>%
  ggplot() +
  geom_sf() +
  geom_sf_label(aes(label = abbrev_state), size = 2)
```

---

Muitas vezes, vamos precisar trazer informações de outras tabelas para incluir nos mapas. No exemplo abaixo, juntamos o número de óbitos totais por COVID no dia 1º de junho de 2020 à tabela com os dados geográficos.

```{r}
tab_covid <- readr::read_rds("data/covid.rds")

tab_estados <- sf::st_simplify(tab_estados, dTolerance = 0.1)

tab_covid_estado <- tab_covid %>%
  filter(
    data == "2020/06/01",
    is.na(codmun),
    !is.na(estado)
  ) %>%
  right_join(tab_estados, by = c("estado" = "abbrev_state"))
```

---

Agora podemos visualizar o número de óbitos por estado no nosso mapa.

```{r}
tab_covid_estado %>%
  ggplot() +
  geom_sf(aes(geometry = geom, fill = obitosAcumulado)) +
  geom_sf_label(aes(geometry = geom, label = estado), size = 2)

```

---

Mudamos a escala de cor usando a função `scale_fill_gradient()`, igual fazemos para qualquer outro tipo de gráfico. 

```{r}
tab_covid_estado %>%
  ggplot() +
  geom_sf(aes(geometry = geom, fill = obitosAcumulado)) +
  geom_sf_label(aes(geometry = geom, label = estado), size = 2) +
  scale_fill_gradient(low = "yellow", high = "red")
```

---
class: titulo
# Construindo temas


---
# Motivação

Vamos supor que queremos fazer um gráfico e apresentá-lo com um visual que combine com o tema da análise.

Como exemplo, vamos fazer um gráfico da audiência média dos episódios do seriado Rick and Morty com um tema que represente o visual da série.

```{r}
rick_and_morty <- readr::read_rds("../data/rick_and_morty.rds")
head(rick_and_morty, 5)
```


----

Vamos começar com um gráfico de linha.

```{r}
rick_and_morty %>%
  ggplot(aes(x = num_episodio, y = qtd_espectadores_EUA)) +
  geom_line()
```

---

Podemos construir um gráfico de barras para incluir a informação da temporada.

```{r}
rick_and_morty %>%
  mutate(num_temporada = as.factor(num_temporada)) %>%
  ggplot(aes(
    x = num_episodio,
    y = qtd_espectadores_EUA,
    fill = num_temporada)
  ) +
  geom_col()
```

---

Arrumando labels e salvando em um objeto.

```{r}
p <- rick_and_morty %>%
  mutate(num_temporada = as.factor(num_temporada)) %>%
  ggplot(aes(
    x = num_episodio,
    y = qtd_espectadores_EUA,
    fill = num_temporada)
  ) +
  geom_col() +
  labs(
    x = "episodio",
    y = "audiencia",
    fill = "temporada",
    title = "Rick and Morty"
  )

p
```

Agora vamos usar a função `theme()` para ajustar o visual.

---

Colocando legenda na parte de baixo.

```{r}
p +
  theme(
    legend.position = "bottom"
  )
```


---

Pintando o fundo de preto.

```{r}
p +
  theme(
    legend.position = "bottom",
    panel.background = element_rect(fill = "black"),
    legend.background = element_rect(fill = "black", color = "black"),
    plot.background = element_rect(fill = "black", color = "black")
  )
```

---

Removendo algumas linhas do gride.

```{r}
p +
  theme(
    legend.position = "bottom",
    panel.background = element_rect(fill = "black"),
    legend.background = element_rect(fill = "black", color = "black"),
    plot.background = element_rect(fill = "black", color = "black"),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank()
  )
```

---

Formatando título. Faça o download da fonte [aqui](https://fontmeme.com/fontes/fonte-get-schwifty/).

```{r}
p +
  theme(
    text = element_text(
      colour = "#11a2c6",
      family = "Get Schwifty",
      size = 16
    ),
    plot.title = element_text(
      family = "Get Schwifty",
      hjust = 0.5,
      size = 30
    ),
    axis.text = element_text(color = "white"),
    axis.ticks.x = element_line(color = "white"),
    panel.grid.major.y = element_line(size = 0.1),
     plot.title = element_text(
      family = "Get Schwifty",
      hjust = 0.5,
      size = 30
    )
  )

p +
  theme(
    text = element_text(
      colour = "#11a2c6",
      family = "Get Schwifty",
      size = 16
    ),
    axis.text = element_text(color = "white"),
    axis.ticks.x = element_line(color = "white"),
    panel.grid.major.y = element_line(size = 0.1)
  )
```

---

Formatando demais textos.

```{r}
p +
  theme(
    text = element_text(
      colour = "#11a2c6",
      family = "Get Schwifty",
      size = 16
    ),
    plot.title = element_text(
      family = "Get Schwifty",
      hjust = 0.5,
      size = 30
    ),
    axis.text = element_text(color = "white"),
    axis.ticks.x = element_line(color = "white"),
    panel.grid.major.y = element_line(size = 0.1),
     plot.title = element_text(
      family = "Get Schwifty",
      hjust = 0.5,
      size = 30
    ),
    text = element_text(
      colour = "#11a2c6",
      family = "Get Schwifty",
      size = 16
    ),
    axis.text = element_text(color = "white")
  )
```


---

Removendo tracinhos do eixo x e diminuindo espessura do gride no eixe y.

```{r}
p +
  theme(
    text = element_text(
      colour = "#11a2c6",
      family = "Get Schwifty",
      size = 16
    ),
    plot.title = element_text(
      family = "Get Schwifty",
      hjust = 0.5,
      size = 30
    ),
    axis.text = element_text(color = "white"),
    axis.ticks.x = element_line(color = "white"),
    panel.grid.major.y = element_line(size = 0.1),
     plot.title = element_text(
      family = "Get Schwifty",
      hjust = 0.5,
      size = 30
    ),
    text = element_text(
      colour = "#11a2c6",
      family = "Get Schwifty",
      size = 16
    ),
    axis.text = element_text(color = "white"),
    axis.ticks.x = element_line(color = "white"),
    panel.grid.major.y = element_line(size = 0.1)
  )
```

---

Criando uma função que aplica o tema

```{r}
tema_rick_and_morty <- function() {
  theme(
    text = element_text(
      colour = "#11a2c6",
      family = "Get Schwifty",
      size = 16
    ),
    plot.title = element_text(
      family = "Get Schwifty",
      hjust = 0.5,
      size = 30
    ),
    axis.text = element_text(color = "white"),
    axis.ticks.x = element_line(color = "white"),
    panel.background = element_rect(fill = "black"),
    panel.grid.major.y = element_line(size = 0.1),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    legend.position = "bottom",
    legend.background = element_rect(fill = "black", color = "black"),
    plot.background = element_rect(fill = "black", color = "black")
  )
}
```

---

Aplicando a nossa função com o tema criado.

```{r}
p +
  tema_rick_and_morty()
```

---

Inserindo imagem.

```{r}
img_rick <- png::readPNG("data-raw/rick.png") %>%
  grid::rasterGrob(interpolate = TRUE)

p +
  annotation_custom(img_rick, xmin = 35, ymin = 2) +
  tema_rick_and_morty()
```

---

Aplicando o tema no gráfico de linha

```{r}
rick_and_morty %>%
  mutate(num_temporada = as.factor(num_temporada)) %>%
  ggplot(aes(x = num_episodio, y = qtd_espectadores_EUA)) +
  geom_line(color = "white") +
  labs(
    x = "episodio",
    y = "audiencia",
    title = "Rick and Morty"
  ) +
  annotation_custom(img_rick, xmin = 35, ymin = 2) +
  tema_rick_and_morty()
```

---
class: titulo
# Extensões do {ggplot2}

---
# gganimate

Veja uma lista de extensões do ggplot2
https://exts.ggplot2.tidyverse.org/gallery/

```{r, eval = FALSE}
install.packages("gganimate")
library(gganimate)

covid <- readr::read_rds("data/covid.rds")
```

---

Série de óbitos dos 10 estados com mais mortes por COVID

```{r}
covid %>%
  filter(
    !is.na(municipio)
  ) %>%
  group_by(estado, data) %>%
  summarise(obitosAcumulado = sum(obitosAcumulado)) %>%
  mutate(num_obitos = max(obitosAcumulado)) %>%
  ungroup() %>%
  mutate(
    limite = num_obitos %>%
      unique() %>%
      sort(decreasing = TRUE) %>%
      nth(10)
  ) %>%
  filter(num_obitos >= limite) %>%
  ggplot(aes(y = obitosAcumulado, x = data, color = estado)) +
  geom_line()
```

---

Transformando em GIF

```{r}
covid %>%
  filter(
    !is.na(municipio)
  ) %>%
  group_by(estado, data) %>%
  summarise(obitosAcumulado = sum(obitosAcumulado)) %>%
  mutate(num_obitos = max(obitosAcumulado)) %>%
  ungroup() %>%
  mutate(
    limite = num_obitos %>%
      unique() %>%
      sort(decreasing = TRUE) %>%
      nth(10)
  ) %>%
  filter(num_obitos >= limite) %>%
  ggplot(aes(y = obitosAcumulado, x = data, color = estado)) +
  geom_line() +
  transition_reveal(data)
```

---

Colocando ponto

```{r}
covid %>%
  filter(
    !is.na(municipio)
  ) %>%
  group_by(estado, data) %>%
  summarise(obitosAcumulado = sum(obitosAcumulado)) %>%
  mutate(num_obitos = max(obitosAcumulado)) %>%
  ungroup() %>%
  mutate(
    limite = num_obitos %>%
      unique() %>%
      sort(decreasing = TRUE) %>%
      nth(10)
  ) %>%
  filter(num_obitos >= limite) %>%
  ggplot(aes(y = obitosAcumulado, x = data, color = estado)) +
  geom_line() +
  geom_point() +
  transition_reveal(data)
```

---

Colocando label

```{r}
covid %>%
  filter(
    !is.na(municipio)
  ) %>%
  group_by(estado, data) %>%
  summarise(obitosAcumulado = sum(obitosAcumulado)) %>%
  mutate(num_obitos = max(obitosAcumulado)) %>%
  ungroup() %>%
  mutate(
    limite = num_obitos %>%
      unique() %>%
      sort(decreasing = TRUE) %>%
      nth(10)
  ) %>%
  filter(num_obitos >= limite) %>%
  ggplot(aes(y = obitosAcumulado, x = data, color = estado)) +
  geom_line(show.legend = FALSE) +
  geom_label(aes(label = estado), show.legend = FALSE) +
  transition_reveal(data)
```

---

```{r, eval = FALSE}
install.packages("gghighlight")
library(gghighlight)

ames <- readr::read_rds("data/ames.rds")
```

---

Área do lote vs valor da venda

```{r}
ames %>%
  mutate(venda_valor = venda_valor/1000) %>%
  ggplot(aes(x = lote_area, y = venda_valor)) +
  geom_point()
```

---

Destacando lotes muito grandes

```{r}
ames %>%
  mutate(venda_valor = round(venda_valor/1000)) %>%
  ggplot(aes(x = lote_area, y = venda_valor)) +
  geom_point() +
  gghighlight(lote_area > 100000, label_key = venda_valor)
```

---

Trocando a cor dos pontos destacados

```{r}
ames %>%
  mutate(venda_valor = round(venda_valor/1000)) %>%
  ggplot(aes(x = lote_area, y = venda_valor)) +
  geom_point(color = "red") +
  gghighlight(
    lote_area > 100000,
    label_key = venda_valor
  )
```

---

Trocando a cor dos outros pontos

```{r}
ames %>%
  mutate(venda_valor = round(venda_valor/1000)) %>%
  ggplot(aes(x = lote_area, y = venda_valor)) +
  geom_point(color = "red") +
  gghighlight(
    lote_area > 100000,
    unhighlighted_colour = "black",
    label_key = venda_valor
  )
```

---

Também funciona com linhas

```{r}
covid %>%
  filter(
    !is.na(municipio)
  ) %>%
  group_by(estado, data) %>%
  summarise(across(c(obitosAcumulado, casosAcumulado), sum)) %>%
  ggplot(aes(y = obitosAcumulado, x = data, group = estado)) +
  geom_line() +
  gghighlight(max(obitosAcumulado) > 3000)
```
